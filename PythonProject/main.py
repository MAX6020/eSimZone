import logging
from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo
from aiogram.filters import Command
from aiogram import F
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.utils.keyboard import InlineKeyboardBuilder
import asyncio
import sqlite3
import json
from datetime import datetime
import os
import re
import urllib.parse

# Настройка логирования
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Токен бота
API_TOKEN = '8370203637:AAHR37024BBaqREiNCyqWG54DvodYjkf8kA'

# Инициализация бота и диспетчера с FSM
storage = MemoryStorage()
bot = Bot(token=API_TOKEN)
dp = Dispatcher(storage=storage)

# База данных SQLite
DB_NAME = 'esim_bot.db'

# URL сайта для оплаты
BASE_PAYMENT_URL = "https://esimzone.ru/buy/&id="

# Вставьте этот код вместо существующего ESIM_DATA в вашем телеграмм боте

ESIM_DATA = [
    {"country": "Объединенные Арабские Эмираты (ОАЭ)", "text": "Операторы -&amp;nbsp;DU / Etisalat", "esims": [
        {"id": "763", "name": "1Гб в ОАЭ на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "295", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "767", "name": "1Гб в ОАЭ на 5 дней", "text": "", "price": "395", "gigs": "1", "days": "5", "spec": ""},
        {"id": "764", "name": "3Гб в ОАЭ на 3 дня", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "625", "gigs": "3", "days": "3", "spec": "hot"},
        {"id": "198", "name": "3Гб в ОАЭ на 7 дней", "text": "", "price": "870", "gigs": "3", "days": "7", "spec": ""},
        {"id": "199", "name": "5Гб в ОАЭ на 15 дней", "text": "", "price": "1195", "gigs": "5", "days": "15", "spec": ""},
        {"id": "765", "name": "7Гб в ОАЭ на 7 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "1250", "gigs": "7", "days": "7", "spec": "hot"},
        {"id": "766", "name": "10Гб в ОАЭ на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "1595", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "841", "name": "10Гб в ОАЭ на 7 дней", "text": "", "price": "1695", "gigs": "10", "days": "7", "spec": ""},
        {"id": "200", "name": "10Гб в ОАЭ на 15 дней", "text": "", "price": "1850", "gigs": "10", "days": "15", "spec": ""},
        {"id": "201", "name": "10Гб в ОАЭ на 30 дней", "text": "", "price": "2125", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Турция", "text": "", "esims": [
        {"id": "202", "name": "1Гб в Турции на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "225", "gigs": "1", "days": "1", "spec": ""},
        {"id": "203", "name": "1Гб в Турции на 3 дня", "text": "", "price": "245", "gigs": "1", "days": "3", "spec": ""},
        {"id": "204", "name": "3Гб в Турции на 7 дней", "text": "", "price": "345", "gigs": "3", "days": "7", "spec": ""},
        {"id": "205", "name": "5Гб в Турции на 15 дней", "text": "", "price": "495", "gigs": "5", "days": "15", "spec": ""},
        {"id": "732", "name": "10Гб в Турции на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости&amp;nbsp;512kbps", "price": "650", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "206", "name": "10Гб в Турции на 30 дней", "text": "", "price": "715", "gigs": "10", "days": "30", "spec": ""},
        {"id": "730", "name": "20Гб в Турции на 30 дней", "text": "", "price": "1195", "gigs": "20", "days": "30", "spec": "hot"},
        {"id": "731", "name": "50Гб в Турции на 30 дней", "text": "", "price": "2295", "gigs": "50", "days": "30", "spec": "hot"}
    ]},
    {"country": "Казахстан", "text": "", "esims": [
        {"id": "207", "name": "1Гб в Казахстане на 1 день", "text": "", "price": "305", "gigs": "1", "days": "1", "spec": ""},
        {"id": "208", "name": "1Гб в Казахстане на 3 дня", "text": "", "price": "325", "gigs": "1", "days": "3", "spec": ""},
        {"id": "209", "name": "3Гб в Казахстане на 7 дней", "text": "", "price": "415", "gigs": "3", "days": "7", "spec": ""},
        {"id": "210", "name": "5Гб в Казахстане на 15 дней", "text": "", "price": "525", "gigs": "5", "days": "15", "spec": ""},
        {"id": "211", "name": "10Гб в Казахстане на 30 дней", "text": "", "price": "795", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Шри-Ланка", "text": "", "esims": [
        {"id": "213", "name": "1Гб в Шри-Ланке на 1 день", "text": "", "price": "350", "gigs": "1", "days": "1", "spec": ""},
        {"id": "214", "name": "1Гб в Шри-Ланке на 3 дня", "text": "", "price": "395", "gigs": "1", "days": "3", "spec": ""},
        {"id": "215", "name": "3Гб в Шри-Ланке на 7 дней", "text": "", "price": "595", "gigs": "3", "days": "7", "spec": ""},
        {"id": "216", "name": "5Гб в Шри-Ланке на 15 дней", "text": "", "price": "775", "gigs": "5", "days": "15", "spec": ""},
        {"id": "217", "name": "10Гб в Шри-Ланке на 30 дней", "text": "", "price": "1295", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Судан", "text": "", "esims": [
        {"id": "218", "name": "1Гб в Судане на 1 день", "text": "", "price": "1655", "gigs": "1", "days": "1", "spec": ""},
        {"id": "219", "name": "1Гб в Судане на 3 дня", "text": "", "price": "1745", "gigs": "1", "days": "3", "spec": ""},
        {"id": "220", "name": "3Гб в Судане на 7 дней", "text": "", "price": "3895", "gigs": "3", "days": "7", "spec": ""},
        {"id": "221", "name": "5Гб в Судане на 15 дней", "text": "", "price": "5825", "gigs": "5", "days": "15", "spec": ""},
        {"id": "222", "name": "10Гб в Судане на 30 дней", "text": "", "price": "10445", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Суринам", "text": "", "esims": [
        {"id": "223", "name": "1Гб в Суринаме на 1 день", "text": "", "price": "2100", "gigs": "1", "days": "1", "spec": ""},
        {"id": "224", "name": "1Гб в Суринаме на 3 дня", "text": "", "price": "2215", "gigs": "1", "days": "3", "spec": ""},
        {"id": "225", "name": "3Гб в Суринаме на 7 дней", "text": "", "price": "5035", "gigs": "3", "days": "7", "spec": ""},
        {"id": "226", "name": "5Гб в Суринаме на 15 дней", "text": "", "price": "7575", "gigs": "5", "days": "15", "spec": ""},
        {"id": "227", "name": "10Гб в Суринаме на 30 дней", "text": "", "price": "13625", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Тайвань", "text": "", "esims": [
        {"id": "228", "name": "1Гб в Тайване на 3 дня", "text": "", "price": "225", "gigs": "1", "days": "3", "spec": ""},
        {"id": "787", "name": "3Гб в Тайване на 3 дня", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps.", "price": "265", "gigs": "3", "days": "3", "spec": "hot"},
        {"id": "229", "name": "3Гб в Тайване на 5 дней", "text": "", "price": "295", "gigs": "3", "days": "5", "spec": ""},
        {"id": "786", "name": "5Гб в Тайване на 5 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps.", "price": "365", "gigs": "5", "days": "5", "spec": "hot"},
        {"id": "230", "name": "5Гб в Тайване на 7 дней", "text": "", "price": "395", "gigs": "5", "days": "7", "spec": ""},
        {"id": "785", "name": "10Гб в Тайване на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps.", "price": "545", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "231", "name": "10Гб в Тайване на 15 дней", "text": "", "price": "595", "gigs": "10", "days": "15", "spec": ""},
        {"id": "783", "name": "15Гб в Тайване на 15 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps.", "price": "745", "gigs": "15", "days": "15", "spec": "hot"},
        {"id": "784", "name": "20Гб в Тайване на 20 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps.", "price": "945", "gigs": "20", "days": "20", "spec": "hot"},
        {"id": "232", "name": "20Гб в Тайване на 30 дней", "text": "", "price": "1125", "gigs": "20", "days": "30", "spec": ""},
        {"id": "782", "name": "30Гб в Тайване на 30 дней", "text": "", "price": "1495", "gigs": "30", "days": "30", "spec": ""}
    ]},
    {"country": "Таджикистан", "text": "", "esims": [
        {"id": "233", "name": "1Гб в Таджикистане на 1 день", "text": "", "price": "435", "gigs": "1", "days": "1", "spec": ""},
        {"id": "234", "name": "1Гб в Таджикистане на 3 дня", "text": "", "price": "455", "gigs": "1", "days": "3", "spec": ""},
        {"id": "235", "name": "3Гб в Таджикистане на 7 дней", "text": "", "price": "745", "gigs": "3", "days": "7", "spec": ""},
        {"id": "236", "name": "5Гб в Таджикистане на 15 дней", "text": "", "price": "1025", "gigs": "5", "days": "15", "spec": ""},
        {"id": "237", "name": "10Гб в Таджикистане на 30 дней", "text": "", "price": "1695", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Танзания", "text": "", "esims": [
        {"id": "817", "name": "1Гб в Африке 18 стран на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "480", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "818", "name": "1Гб в Африке 18 стран на 5 дней", "text": "", "price": "595", "gigs": "1", "days": "5", "spec": ""},
        {"id": "819", "name": "3Гб в Африке 18 стран на 7 дней", "text": "", "price": "1095", "gigs": "3", "days": "7", "spec": ""},
        {"id": "820", "name": "5Гб в Африке 18 стран на 15 дней", "text": "", "price": "1670", "gigs": "5", "days": "15", "spec": ""},
        {"id": "822", "name": "10Гб в Африке 18 стран на 7 дней", "text": "", "price": "2395", "gigs": "10", "days": "7", "spec": "hot"},
        {"id": "821", "name": "10Гб в Африке 18 стран на 30 дней", "text": "", "price": "2625", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Тайланд", "text": "", "esims": [
        {"id": "753", "name": "1Гб в Таиланде + Малайзии + Сингапуре на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "195", "gigs": "1", "days": "1", "spec": ""},
        {"id": "754", "name": "3Гб в Таиланде + Малайзии + Сингапуре на 3 дня", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "295", "gigs": "3", "days": "3", "spec": ""},
        {"id": "755", "name": "5Гб в Таиланде + Малайзии + Сингапуре на 5 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "395", "gigs": "5", "days": "5", "spec": ""},
        {"id": "756", "name": "7Гб в Таиланде + Малайзии + Сингапуре на 7 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "495", "gigs": "7", "days": "7", "spec": ""},
        {"id": "759", "name": "5Гб в Таиланде + Малайзии + Сингапуре на 30 дней", "text": "", "price": "495", "gigs": "5", "days": "30", "spec": ""},
        {"id": "757", "name": "10Гб в Таиланде + Малайзии + Сингапуре на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "595", "gigs": "10", "days": "10", "spec": ""},
        {"id": "760", "name": "10Гб в Таиланде + Малайзии + Сингапуре на 30 дней", "text": "", "price": "795", "gigs": "10", "days": "30", "spec": ""},
        {"id": "758", "name": "20Гб в Таиланде + Малайзии + Сингапуре на 20 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "995", "gigs": "20", "days": "20", "spec": ""},
        {"id": "761", "name": "20Гб в Таиланде + Малайзии + Сингапуре на 30 дней", "text": "", "price": "1250", "gigs": "20", "days": "30", "spec": ""},
        {"id": "762", "name": "50Гб в Таиланде + Малайзии + Сингапуре на 30 дней", "text": "", "price": "2695", "gigs": "50", "days": "30", "spec": ""}
    ]},
    {"country": "Тонго", "text": "", "esims": [
        {"id": "248", "name": "1Гб в Тонго на 1 день", "text": "", "price": "8625", "gigs": "1", "days": "1", "spec": ""},
        {"id": "249", "name": "1Гб в Тонго на 3 дня", "text": "", "price": "9085", "gigs": "1", "days": "3", "spec": ""},
        {"id": "250", "name": "3Гб в Тонго на 7 дней", "text": "", "price": "21810", "gigs": "3", "days": "7", "spec": ""},
        {"id": "251", "name": "5Гб в Тонго на 15 дней", "text": "", "price": "33210", "gigs": "5", "days": "15", "spec": ""},
        {"id": "252", "name": "10Гб в Тонго на 30 дней", "text": "", "price": "60225", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Тринидад и Тобаго", "text": "", "esims": [
        {"id": "253", "name": "1Гб в Тринидад и Тобаго на 1 день", "text": "", "price": "2100", "gigs": "1", "days": "1", "spec": ""},
        {"id": "254", "name": "1Гб в Тринидад и Тобаго на 3 дня", "text": "", "price": "2225", "gigs": "1", "days": "3", "spec": ""},
        {"id": "255", "name": "3Гб в Тринидад и Тобаго на 7 дней", "text": "", "price": "5035", "gigs": "3", "days": "7", "spec": ""},
        {"id": "256", "name": "5Гб в Тринидад и Тобаго на 15 дней", "text": "", "price": "7580", "gigs": "5", "days": "15", "spec": ""},
        {"id": "257", "name": "10Гб в Тринидад и Тобаго на 30 дней", "text": "", "price": "13625", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Тунис", "text": "", "esims": [
        {"id": "258", "name": "1Гб в Тунисе на 1 день", "text": "", "price": "345", "gigs": "1", "days": "1", "spec": ""},
        {"id": "259", "name": "1Гб в Тунисе на 3 дня", "text": "", "price": "365", "gigs": "1", "days": "3", "spec": ""},
        {"id": "260", "name": "3Гб в Тунисе на 7 дней", "text": "", "price": "515", "gigs": "3", "days": "7", "spec": ""},
        {"id": "261", "name": "5Гб в Тунисе на 15 дней", "text": "", "price": "670", "gigs": "5", "days": "15", "spec": ""},
        {"id": "262", "name": "10Гб в Тунисе на 30 дней", "text": "", "price": "1065", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Теркс и Кайкос", "text": "", "esims": [
        {"id": "263", "name": "1Гб в Теркс и Кайкос на 1 день", "text": "", "price": "855", "gigs": "1", "days": "1", "spec": ""},
        {"id": "264", "name": "1Гб в Теркс и Кайкос на 3 дня", "text": "", "price": "895", "gigs": "1", "days": "3", "spec": ""},
        {"id": "265", "name": "3Гб в Теркс и Кайкос на 7 дней", "text": "", "price": "1825", "gigs": "3", "days": "7", "spec": ""},
        {"id": "266", "name": "5Гб в Теркс и Кайкос на 15 дней", "text": "", "price": "2675", "gigs": "5", "days": "15", "spec": ""},
        {"id": "267", "name": "10Гб в Теркс и Кайкос на 30 дней", "text": "", "price": "4695", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Уганда", "text": "", "esims": [
        {"id": "817", "name": "1Гб в Африке 18 стран на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "480", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "818", "name": "1Гб в Африке 18 стран на 5 дней", "text": "", "price": "595", "gigs": "1", "days": "5", "spec": ""},
        {"id": "819", "name": "3Гб в Африке 18 стран на 7 дней", "text": "", "price": "1095", "gigs": "3", "days": "7", "spec": ""},
        {"id": "820", "name": "5Гб в Африке 18 стран на 15 дней", "text": "", "price": "1670", "gigs": "5", "days": "15", "spec": ""},
        {"id": "822", "name": "10Гб в Африке 18 стран на 7 дней", "text": "", "price": "2395", "gigs": "10", "days": "7", "spec": "hot"},
        {"id": "821", "name": "10Гб в Африке 18 стран на 30 дней", "text": "", "price": "2625", "gigs": "10", "days": "30", "spec": ""}
    ]},
]

ESIM_DATA.extend([
    {"country": "США", "text": "Операторы&amp;nbsp;T-Mobile/AT&amp;amp;T", "esims": [
        {"id": "747", "name": "1Гб в США на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "245", "gigs": "1", "days": "1", "spec": ""},
        {"id": "748", "name": "3Гб в США на 3 дня", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "365", "gigs": "3", "days": "3", "spec": ""},
        {"id": "749", "name": "5Гб в США на 5 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "495", "gigs": "5", "days": "5", "spec": ""},
        {"id": "750", "name": "10Гб в США на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "835", "gigs": "10", "days": "10", "spec": ""},
        {"id": "751", "name": "10Гб в США на 30 дней", "text": "", "price": "895", "gigs": "10", "days": "30", "spec": ""},
        {"id": "752", "name": "20Гб в США на 30 дней", "text": "", "price": "1495", "gigs": "20", "days": "30", "spec": ""}
    ]},
    {"country": "Уругвай", "text": "", "esims": [
        {"id": "278", "name": "1Гб в Уругвае на 1 день", "text": "", "price": "495", "gigs": "1", "days": "1", "spec": ""},
        {"id": "279", "name": "1Гб в Уругвае на 3 дня", "text": "", "price": "525", "gigs": "1", "days": "3", "spec": ""},
        {"id": "280", "name": "3Гб в Уругвае на 7 дней", "text": "", "price": "905", "gigs": "3", "days": "7", "spec": ""},
        {"id": "281", "name": "5Гб в Уругвае на 15 дней", "text": "", "price": "1270", "gigs": "5", "days": "15", "spec": ""},
        {"id": "282", "name": "10Гб в Уругвае на 30 дней", "text": "", "price": "2155", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Узбекистан", "text": "", "esims": [
        {"id": "283", "name": "1Гб в Узбекистане на 1 день", "text": "", "price": "305", "gigs": "1", "days": "1", "spec": ""},
        {"id": "284", "name": "1Гб в Узбекистане на 3 дня", "text": "", "price": "325", "gigs": "1", "days": "3", "spec": ""},
        {"id": "285", "name": "3Гб в Узбекистане на 7 дней", "text": "", "price": "415", "gigs": "3", "days": "7", "spec": ""},
        {"id": "286", "name": "5Гб в Узбекистане на 15 дней", "text": "", "price": "525", "gigs": "5", "days": "15", "spec": ""},
        {"id": "287", "name": "10Гб в Узбекистане на 30 дней", "text": "", "price": "795", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Вануату", "text": "Страны&amp;nbsp;\r\nАлбания, Алжир, Ангилья, Антигуа и Барбуда, Аргентина, Армения, Аруба, Австралия, Австрия, Азербайджан, Бангладеш, Барбадос, Беларусь, Бельгия, Бермудские острова, Босния и Герцеговина, Бразилия, Британские Виргинские острова, Бруней, Болгария, Камбоджа, Камерун, Канада, Каймановы острова, Центральная Африка, Чили, Колумбия, Коста-Рика, Кот-д`Ивуар, Хорватия, Кипр, Чешская Республика, Демократическая Республика Конго, Дания, Доминика, Доминиканская Республика, Египет, Эквадор, Сальвадор, Эстония, Фарерские острова, Фиджи, Финляндия, Франция, Французская Гвиана, Грузия, Германия, Гана, Гибралтар, Греция, Гренада, Гваделупа, Гуам, Гватемала, Гаити, Гондурас, Гонконг, Китай, Венгрия, Исландия, Индия, Индонезия, Иран, Ирландия, Израиль, Италия, Ямайка, Япония, Иордания, Кувейт, Кыргызстан, Казахстан, Кения, Лаос, Латвия. Либерия, Мадагаскар, Литва, Люксембург, Макао, Китай, Малайзия, Мальта, Малави, Мартиника, Маврикий, Мексика, Молдова, Монголия, Черногория, Марокко, Мозамбик, Мьянма, Непал, Нидерланды, Новая Зеландия, Никарагуа, Норвегия, Оман, Пакистан, Панама, Папуа-Новая Гвинея, Парагвай, Перу, Филиппины, Польша, Португалия, Румыния, Катар, Руанда, Кения, Саудовская Аравия, Сербия, Сейшельские острова, Сьерра-Леоне, Сингапур, Словакия, Словения, Южная Африка, Южная Корея, Испания, Шри-Ланка, Сент-Китс и Невис, Сент-Люсия, Сент-Винсент, Судан, Швеция, Швейцария, Тайвань, Китай, Таджикистан, Танзания, Таиланд, Тонга, Тринидад и Тобаго, Тунис, Турция, Теркс и Кайкос, Объединенные Арабские Эмираты, Уганда, Соединенное Королевство, Уругвай, Соединенные Штаты, Узбекистан, Вануату, Вьетнам, Йемен, Замбия", "esims": [
        {"id": "288", "name": "1Гб в Вануату на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "725", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "289", "name": "1Гб в Вануату на 3 дня", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "1895", "gigs": "3", "days": "3", "spec": "hot"},
        {"id": "290", "name": "5Гб в Вануату на 5 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "3065", "gigs": "5", "days": "5", "spec": "hot"},
        {"id": "291", "name": "7Гб в Вануату на 7 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "4240", "gigs": "7", "days": "7", "spec": "hot"},
        {"id": "292", "name": "10Гб в Вануату на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "5985", "gigs": "10", "days": "10", "spec": "hot"}
    ]},
    {"country": "Венесуэла", "text": "", "esims": [
        {"id": "293", "name": "1Гб в Венесуэле на 1 день", "text": "", "price": "1145", "gigs": "1", "days": "1", "spec": ""},
        {"id": "294", "name": "1Гб в Венесуэле на 3 дня", "text": "", "price": "1205", "gigs": "1", "days": "3", "spec": ""},
        {"id": "295", "name": "3Гб в Венесуэле на 7 дней", "text": "", "price": "2575", "gigs": "3", "days": "7", "spec": ""},
        {"id": "296", "name": "5Гб в Венесуэле на 15 дней", "text": "", "price": "3825", "gigs": "5", "days": "15", "spec": ""},
        {"id": "297", "name": "10Гб в Венесуэле на 30 дней", "text": "", "price": "6795", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Вьетнам", "text": "", "esims": [
        {"id": "298", "name": "1Гб во Вьетнаме на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "245", "gigs": "1", "days": "1", "spec": ""},
        {"id": "299", "name": "1Гб во Вьетнаме на 5 дней", "text": "", "price": "265", "gigs": "1", "days": "5", "spec": ""},
        {"id": "300", "name": "3Гб во Вьетнаме на 7 дней", "text": "", "price": "395", "gigs": "3", "days": "7", "spec": ""},
        {"id": "301", "name": "5Гб во Вьетнаме на 10 дней", "text": "", "price": "525", "gigs": "5", "days": "10", "spec": ""},
        {"id": "723", "name": "10Гб во Вьетнаме на 20 дней", "text": "", "price": "835", "gigs": "10", "days": "20", "spec": "hot"},
        {"id": "729", "name": "14Гб во Вьетнаме на 7 дней", "text": "Безлимит - 2Гб в день на полной скорости, остальное на скорости&amp;nbsp;384kbps", "price": "850", "gigs": "14", "days": "7", "spec": "hot"},
        {"id": "802", "name": "50Гб во Вьетнаме на 10 дней", "text": "Безлимит - 5Гб в день на полной скорости, остальное на скорости 384kbps", "price": "1295", "gigs": "50", "days": "10", "spec": "hot"},
        {"id": "302", "name": "20Гб во Вьетнаме на 30 дней", "text": "", "price": "1525", "gigs": "20", "days": "30", "spec": ""}
    ]},
    {"country": "Замбия", "text": "", "esims": [
        {"id": "303", "name": "1Гб в Замбии на 1 день", "text": "", "price": "715", "gigs": "1", "days": "1", "spec": ""},
        {"id": "304", "name": "1Гб в Замбии на 3 дня", "text": "", "price": "750", "gigs": "1", "days": "3", "spec": ""},
        {"id": "305", "name": "3Гб в Замбии на 7 дней", "text": "", "price": "1465", "gigs": "3", "days": "7", "spec": ""},
        {"id": "306", "name": "5Гб в Замбии на 15 дней", "text": "", "price": "2125", "gigs": "5", "days": "15", "spec": ""},
        {"id": "307", "name": "10Гб в Замбии на 30 дней", "text": "", "price": "3705", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Зимбабве", "text": "", "esims": [
        {"id": "308", "name": "1Гб в Зимбабве на 1 день", "text": "", "price": "14975", "gigs": "1", "days": "1", "spec": ""},
        {"id": "309", "name": "1Гб в Зимбабве на 3 дня", "text": "", "price": "15775", "gigs": "1", "days": "3", "spec": ""},
        {"id": "310", "name": "3Гб в Зимбабве на 7 дней", "text": "", "price": "38125", "gigs": "3", "days": "7", "spec": ""},
        {"id": "311", "name": "5Гб в Зимбабве на 15 дней", "text": "", "price": "58145", "gigs": "5", "days": "10", "spec": ""},
        {"id": "312", "name": "10Гб в Зимбабве на 30 дней", "text": "", "price": "105555", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Мексика", "text": "Оператор AT&amp;amp;T\r\nТакже связь будет работать в США и Канаде", "esims": [
        {"id": "315", "name": "1Гб в Мексике на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "305", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "316", "name": "1Гб в Мексике на 3 дня", "text": "", "price": "365", "gigs": "1", "days": "3", "spec": ""},
        {"id": "317", "name": "3Гб в Мексике на 7 дней", "text": "", "price": "695", "gigs": "3", "days": "7", "spec": ""},
        {"id": "318", "name": "5Гб в Мексике на 15 дней", "text": "", "price": "1075", "gigs": "5", "days": "15", "spec": ""},
        {"id": "824", "name": "10Гб в Мексике на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "1425", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "319", "name": "10Гб в Мексике на 30 дней", "text": "", "price": "1845", "gigs": "10", "days": "30", "spec": ""},
        {"id": "823", "name": "20Гб в Мексике на 30 дней", "text": "", "price": "3240", "gigs": "20", "days": "30", "spec": ""}
    ]},
    {"country": "Европа 42 страны", "text": "Универсальная ЕСИМ карта для путешествий по Шенгенской Европе и некоторым другим европейским странам. Полный список стран:\r\nАлбания Андорра Австрия Бельгия Босния и Герцеговина Болгария Хорватия Кипр Чехия Дания Эстония Финляндия Франция Германия Гибралтар Греция Венгрия Исландия Ирландия Италия Косово Латвия Лихтенштейн Литва Люксембург Македония Мальта Молдова Черногория Нидерланды Голландия Норвегия Польша Португалия Румыния Сербия Словакия Словения Испания Швеция Швейцария Великобритания Англия&amp;nbsp;\r\nЕсли вам достаточно меньше стран Европы и вы хотите сэкономить, пожалуйста, воспользуйтесь тарифами из раздела&amp;nbsp;Европа 32 страны, они ниже на 10-40%. Там нет части стран из восточной Европы и Балкан.\r\nОбратите внимание также на тарифы раздела&amp;nbsp;Европа 38 стран + Турция + Беларусь, туда входят Турция и Белоруссия, но не входят Польша, Косово, Гибралтар и Андорра.&amp;nbsp;", "esims": [
        {"id": "320", "name": "1Гб в Европе на 1 день", "text": "", "price": "350", "gigs": "1", "days": "1", "spec": ""},
        {"id": "321", "name": "1Гб в Европе на 3 дня", "text": "", "price": "365", "gigs": "1", "days": "3", "spec": ""},
        {"id": "322", "name": "3Гб в Европе на 7 дней", "text": "", "price": "445", "gigs": "3", "days": "7", "spec": ""},
        {"id": "323", "name": "5Гб в Европе на 15 дней", "text": "", "price": "575", "gigs": "5", "days": "15", "spec": ""},
        {"id": "324", "name": "10Гб в Европе на 30 дней", "text": "", "price": "895", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Армения", "text": "", "esims": [
        {"id": "325", "name": "1Гб в Армении на 1 день", "text": "", "price": "345", "gigs": "1", "days": "1", "spec": ""},
        {"id": "326", "name": "1Гб в Армении на 3 дня", "text": "", "price": "360", "gigs": "1", "days": "3", "spec": ""},
        {"id": "327", "name": "3Гб в Армении на 7 дней", "text": "", "price": "515", "gigs": "3", "days": "7", "spec": ""},
        {"id": "328", "name": "5Гб в Армении на 15 дней", "text": "", "price": "670", "gigs": "5", "days": "15", "spec": ""},
        {"id": "329", "name": "10Гб в Армении на 30 дней", "text": "", "price": "1065", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Азербайджан", "text": "", "esims": [
        {"id": "330", "name": "1Гб в Азербайджане на 1 день", "text": "", "price": "435", "gigs": "1", "days": "1", "spec": ""},
        {"id": "331", "name": "1Гб в Азербайджане на 3 дня", "text": "", "price": "455", "gigs": "1", "days": "3", "spec": ""},
        {"id": "332", "name": "3Гб в Азербайджане на 7 дней", "text": "", "price": "745", "gigs": "3", "days": "7", "spec": ""},
        {"id": "333", "name": "5Гб в Азербайджане на 15 дней", "text": "", "price": "1025", "gigs": "5", "days": "15", "spec": ""},
        {"id": "334", "name": "10Гб в Азербайджане на 30 дней", "text": "", "price": "1695", "gigs": "10", "days": "30", "spec": ""}
    ]},
])

ESIM_DATA.extend([
    {"country": "Китай", "text": "", "esims": [
        {"id": "725", "name": "1Гб в Китае+Гонконг+Макао на 3 дня", "text": "Китай, Гонконг, Макао. Google,  Whatsapp, Youtube, Insta - поддерживаются", "price": "245", "gigs": "1", "days": "3", "spec": "hot"},
        {"id": "726", "name": "3Гб в Китае+Гонконг+Макао на 7 дней", "text": "Китай, Гонконг, Макао. Google,  Whatsapp, Youtube, Insta - поддерживаются", "price": "375", "gigs": "3", "days": "7", "spec": "hot"},
        {"id": "727", "name": "5Гб в Китае+Гонконг+Макао на 15 дней", "text": "Китай, Гонконг, Макао. Google,  Whatsapp, Youtube, Insta - поддерживаются", "price": "495", "gigs": "5", "days": "15", "spec": "hot"},
        {"id": "779", "name": "7Гб в Китае+Гонконг+Макао на 7 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps. Китай, Гонконг, Макао. Google,  Whatsapp, Youtube, Insta - поддерживаются", "price": "595", "gigs": "7", "days": "7", "spec": "hot"},
        {"id": "778", "name": "10Гб в Китае+Гонконг+Макао на 15 дней", "text": "Китай, Гонконг, Макао. Google,  Whatsapp, Youtube, Insta - поддерживаются", "price": "765", "gigs": "10", "days": "15", "spec": "hot"},
        {"id": "707", "name": "10Гб в Китае (Mainland) на 30 дней", "text": "Китай, кроме Гонконга и Макао. Google, YT, WA, Inst, TikTok, Chatgpt - поддерживаются", "price": "795", "gigs": "10", "days": "30", "spec": ""},
        {"id": "780", "name": "15Гб в Китае+Гонконг+Макао на 15 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps. Китай, Гонконг, Макао. Google,  Whatsapp, Youtube, Insta - поддерживаются", "price": "1150", "gigs": "15", "days": "15", "spec": "hot"},
        {"id": "728", "name": "20Гб в Китае+Гонконг+Макао на 30 дней", "text": "Китай, Гонконг, Макао. Google,  Whatsapp, Youtube, Insta - поддерживаются", "price": "1495", "gigs": "20", "days": "30", "spec": "hot"},
        {"id": "781", "name": "50Гб в Китае+Гонконг+Макао на 30 дней", "text": "Китай, Гонконг, Макао. Google,  Whatsapp, Youtube, Insta - поддерживаются", "price": "3095", "gigs": "50", "days": "30", "spec": "hot"}
    ]},
    {"country": "Куба", "text": "", "esims": [
        {"id": "340", "name": "1Гб на Кубе на 1 день", "text": "", "price": "2065", "gigs": "1", "days": "1", "spec": ""},
        {"id": "341", "name": "1Гб на Кубе на 3 дня", "text": "", "price": "2175", "gigs": "1", "days": "3", "spec": ""},
        {"id": "342", "name": "3Гб на Кубе на 7 дней", "text": "", "price": "4935", "gigs": "3", "days": "7", "spec": ""},
        {"id": "343", "name": "5Гб на Кубе на 15 дней", "text": "", "price": "7430", "gigs": "5", "days": "15", "spec": ""},
        {"id": "344", "name": "10Гб на Кубе на 30 дней", "text": "", "price": "13350", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Египет", "text": "", "esims": [
        {"id": "812", "name": "1Гб в Египте на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbpsVodafone / Orange", "price": "295", "gigs": "1", "days": "1", "spec": ""},
        {"id": "813", "name": "1Гб в Египте на 3 дня", "text": "Vodafone / Orange", "price": "325", "gigs": "1", "days": "3", "spec": ""},
        {"id": "347", "name": "3Гб в Египте на 7 дней", "text": "Etisalat", "price": "525", "gigs": "3", "days": "7", "spec": ""},
        {"id": "814", "name": "3Гб в Египте на 10 дней", "text": "Vodafone / Orange", "price": "595", "gigs": "3", "days": "10", "spec": ""},
        {"id": "348", "name": "5Гб в Египте на 15 дней", "text": "Etisalat", "price": "675", "gigs": "5", "days": "15", "spec": "hot"},
        {"id": "815", "name": "5Гб в Египте на 15 дней", "text": "Vodafone / Orange", "price": "895", "gigs": "5", "days": "15", "spec": ""},
        {"id": "349", "name": "10Гб в Египте на 30 дней", "text": "Etisalat", "price": "1065", "gigs": "10", "days": "30", "spec": "hot"},
        {"id": "816", "name": "10Гб в Египте на 10 дней", "text": "Vodafone / Orange", "price": "1555", "gigs": "10", "days": "10", "spec": ""}
    ]},
    {"country": "Грузия", "text": "", "esims": [
        {"id": "350", "name": "1Гб в Грузии на 1 день", "text": "", "price": "385", "gigs": "1", "days": "1", "spec": ""},
        {"id": "351", "name": "1Гб в Грузии на 3 дня", "text": "", "price": "405", "gigs": "1", "days": "3", "spec": ""},
        {"id": "352", "name": "3Гб в Грузии на 7 дней", "text": "", "price": "625", "gigs": "3", "days": "7", "spec": ""},
        {"id": "353", "name": "5Гб в Грузии на 15 дней", "text": "", "price": "825", "gigs": "5", "days": "15", "spec": ""},
        {"id": "354", "name": "10Гб в Грузии на 30 дней", "text": "", "price": "1340", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Белоруссия", "text": "Оператор: Unitary velcom\r\nОбратите внимание на тарифы раздела Европа 39 стран + Турция + Беларусь, туда входит Белоруссия, цены ниже на 10-20%, операторы - Unitary velcom/BEST", "esims": [
        {"id": "355", "name": "1Гб в Белоруссии на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "235", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "356", "name": "1Гб в Белоруссии на 3 дня", "text": "", "price": "265", "gigs": "1", "days": "3", "spec": ""},
        {"id": "357", "name": "3Гб в Белоруссии на 7 дней", "text": "", "price": "395", "gigs": "3", "days": "7", "spec": ""},
        {"id": "358", "name": "5Гб в Белоруссии на 15 дней", "text": "", "price": "545", "gigs": "5", "days": "15", "spec": ""},
        {"id": "825", "name": "7Гб в Белоруссии на 7 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "555", "gigs": "7", "days": "7", "spec": "hot"},
        {"id": "359", "name": "10Гб в Белоруссии на 30 дней", "text": "", "price": "795", "gigs": "10", "days": "30", "spec": ""},
        {"id": "440", "name": "50Гб в Белоруссии на 30 дней", "text": "", "price": "2595", "gigs": "50", "days": "30", "spec": ""}
    ]},
    {"country": "Европа 32 страны", "text": "Страны:&amp;nbsp;Австрия, Бельгия, Болгария, Великобритания, Венгрия, Германия, Греция, Дания, Ирландия, Исландия, Испания, Италия, Кипр, Латвия, Литва, Лихтенштейн, Люксембург, Мальта, Молдова, Нидерланды, Норвегия, Португалия, Румыния, Словакия, Словения, Финляндия, Франция, Хорватия, Чехия, Швейцария, Швеция, Эстония\r\nЕсли вам нужно больше стран Европы - пожалуйста, воспользуйтесь тарифами из раздела Европа 42 страны, правда, они немного дороже.\r\nОбратите внимание также на тарифы раздела&amp;nbsp;Европа 38 стран + Турция + Беларусь, туда входят Турция и Белоруссия.\r\n&amp;nbsp;\r\nСтраны и операторы: Austria:H3G/T-Mobile/A1, Belgium:Telenet/ORANGE, Bulgaria:Mobiltel/Telenor/Vivacom, Croatia:Hrvatski/Tele2/VIPnet, Cyprus:CYTA/Primetel/Epic, Czech Republic:Vodafone/O2/T-Mobile, Denmark:Telenor/HI3G/Telia/TDC/nuuday, Estonia:Telia/Tele2/Elisa, Finland:DNA/Elisa/Telia, France:Orange/Bouygues/Free Mobile, Germany:T-Mobile/Vodafone, Greece:Cosmote/Vodafone/Wind(Nova), Hungary:Telenor/T-Mobile/Vodafone, Iceland:Landssiminn - ISLPS, Ireland:H3G/Vodafone, Italy:ILIAD/H3G/Vodafone/Telecom/Wind, Latvia:Tele2/Bite/Mobilais, Liechtenstein:Orange/Telecom AG, Lithuania:Tele2/Bite/Omnitel, Luxembourg:Orange, Malta:GO/Vodafone, Moldova:Orange, Netherlands:Vodafone/Odido/KPN/KPN/Telfort, Norway:Telia/Network AS/Telenor, Portugal:Optimus/Vodafone, Romania:DIGI/Telekom/Vodafone/Orange, Slovakia:Slovak Telekom (DT)/Orange/O2, Slovenia:Telekom/A1/Telemach, Spain:Vodafone/Orange/Yoigo(Xfera Moviles), Sweden:Telenor (Vodafone)/H3G/Tele2/Telia, Switzerland:Swisscom/Sunrise/Salt, United Kingdom:H3G/EE/Vodafone", "esims": [
        {"id": "739", "name": "1Гб в Европе (32 страны) на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "225", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "740", "name": "3Гб в Европе (32 страны) на 3 дня", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "325", "gigs": "3", "days": "3", "spec": "hot"},
        {"id": "741", "name": "5Гб в Европе (32 страны) на 5 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "395", "gigs": "5", "days": "5", "spec": "hot"},
        {"id": "742", "name": "10Гб в Европе (32 страны) на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "625", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "743", "name": "10Гб в Европе (32 страны) на 30 дней", "text": "", "price": "695", "gigs": "10", "days": "30", "spec": ""},
        {"id": "744", "name": "20Гб в Европе (32 страны) на 30 дней", "text": "", "price": "1095", "gigs": "20", "days": "30", "spec": ""},
        {"id": "745", "name": "30Гб в Европе (32 страны) на 30 дней", "text": "", "price": "1495", "gigs": "30", "days": "30", "spec": ""},
        {"id": "746", "name": "50Гб в Европе (32 страны) на 30 дней", "text": "", "price": "2095", "gigs": "50", "days": "30", "spec": ""}
    ]},
    {"country": "Европа 38 стран + Турция + Беларусь", "text": "Список стран: Австрия, Албания, Белоруссия, Бельгия, Болгария, Босния и Герцеговина, Великобритания, Венгрия, Германия, Греция, Дания, Ирландия, Исландия, Испания, Италия, Кипр, Латвия, Литва, Лихтенштейн, Люксембург, Македония, Мальта, Молдова, Нидерланды, Норвегия, Португалия, Румыния, Сербия, Словакия Словения, Турция, Фарерские острова, Финляндия, Франция, Хорватия, Черногория, Чехия, Швейцария, Швеция, Эстония\r\nЕсть Турция и Белоруссия!\r\nНет Польши, Косово, Андорры и Гибралтара! Эти страны Европы&amp;nbsp;- есть в тарифах раздела&amp;nbsp;Европа 42 страны.\r\nЕсли вам достаточно меньше стран Европы и вы хотите сэкономить, пожалуйста, воспользуйтесь тарифами из раздела&amp;nbsp;Европа 32 страны, они ниже на 10-40%. Там нет части стран из восточной Европы и Балкан.\r\nСтраны и операторы: Austria:H3G/T-Mobile/A1, Belgium:Telenet/ORANGE, Bulgaria:Mobiltel/Telenor/Vivacom, Switzerland:Swisscom/Sunrise/Salt, Cyprus:CYTA/Primetel/Epic, Czech Republic:Vodafone/O2/T-Mobile, Germany:T-Mobile/Vodafone, Denmark:Telenor/HI3G/Telia/TDC/nuuday, Spain:Vodafone/Orange/Yoigo(Xfera Moviles), Estonia:Telia/Tele2/Elisa, Finland:DNA/Elisa/Telia, France:Orange/Bouygues/Free Mobile, United Kingdom:H3G/EE/Vodafone, Greece:Cosmote/Vodafone/Wind(Nova), Croatia:Hrvatski/Tele2/VIPnet, Hungary:Telenor/T-Mobile/Vodafone, Ireland:H3G/Vodafone, Iceland:Landssiminn - ISLPS, Italy:ILIAD/H3G/Vodafone/Telecom/Wind, Liechtenstein:Orange/Telecom AG, Lithuania:Tele2/Bite/Omnitel, Luxembourg:Orange, Latvia:Tele2/Bite/Mobilais, Moldova:Orange, Malta:GO/Vodafone, Netherlands:Vodafone/Odido/KPN/KPN/Telfort, Norway:Telia/Network AS/Telenor, Portugal:Optimus/Vodafone, Romania:DIGI/Telekom/Vodafone/Orange, Slovakia:Slovak Telekom (DT)/Orange/O2, Slovenia:Telekom/A1/Telemach, Sweden:Telenor (Vodafone)/H3G/Tele2/Telia, Albania:TELEKOM/Eagle Mobile, Bosnia and Herzegovina:Public Enterprise, Belarus:Unitary velcom/BEST, Faroe Islands:Vodafone, Macedonia:ONE/Cosmofone/Makedonski Telekom AD Skopje/VIP Mobile, Montenegro:Crnogorski Telekom/Telenor d o o Podgorica, Serbia:Vip mobile/Telekom/Telenor, Turkey:Turkcell/AVEA\r\n\r\n\r\n  \r\n\r\n\r\nАвстрия\r\n\r\n\r\nАлбания\r\n\r\n\r\nБелоруссия\r\n\r\n\r\nБельгия\r\n\r\n\r\nБолгария\r\n\r\n\r\nБосния и Герцеговина\r\n\r\n\r\nВеликобритания\r\n\r\n\r\nВенгрия\r\n\r\n\r\nГермания\r\n\r\n\r\nГреция\r\n\r\n\r\nДания\r\n\r\n\r\nИрландия\r\n\r\n\r\nИсландия\r\n\r\n\r\nИспания\r\n\r\n\r\nИталия\r\n\r\n\r\nКипр\r\n\r\n\r\nКосово\r\n\r\n\r\nЛатвия\r\n\r\n\r\nЛитва\r\n\r\n\r\nЛихтенштейн\r\n\r\n\r\nЛюксембург\r\n\r\n\r\nМакедония\r\n\r\n\r\nМальта\r\n\r\n\r\nМолдова\r\n\r\n\r\nНидерланды\r\n\r\n\r\nНорвегия\r\n\r\n\r\nПортугалия\r\n\r\n\r\nРумыния\r\n\r\n\r\nСербия\r\n\r\n\r\nСловакия\r\n\r\n\r\nСловения\r\n\r\n\r\nТурция\r\n\r\n\r\nФарерские острова\r\n\r\n\r\nФинляндия\r\n\r\n\r\nФранция\r\n\r\n\r\nХорватия\r\n\r\n\r\nЧерногория\r\n\r\n\r\nЧехия\r\n\r\n\r\nШвейцария\r\n\r\n\r\nШвеция\r\n\r\n\r\nЭстония", "esims": [
        {"id": "768", "name": "1Гб в Европе 38 стран + Турция + Беларусь на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "250", "gigs": "1", "days": "1", "spec": ""},
        {"id": "773", "name": "1Гб в Европе 38 стран + Турция + Беларусь на 5 дней", "text": "", "price": "295", "gigs": "1", "days": "5", "spec": ""},
        {"id": "769", "name": "3Гб в Европе 38 стран + Турция + Беларусь на 3 дня", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "350", "gigs": "3", "days": "3", "spec": ""},
        {"id": "770", "name": "5Гб в Европе 38 стран + Турция + Беларусь на 5 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "475", "gigs": "5", "days": "5", "spec": ""},
        {"id": "774", "name": "5Гб в Европе 38 стран + Турция + Беларусь на 10 дней", "text": "", "price": "545", "gigs": "5", "days": "10", "spec": ""},
        {"id": "771", "name": "7Гб в Европе 38 стран + Турция + Беларусь на 7 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "595", "gigs": "7", "days": "7", "spec": ""},
        {"id": "772", "name": "10Гб в Европе 38 стран + Турция + Беларусь на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "750", "gigs": "10", "days": "10", "spec": ""},
        {"id": "775", "name": "10Гб в Европе 38 стран + Турция + Беларусь на 15 дней", "text": "", "price": "795", "gigs": "10", "days": "15", "spec": ""},
        {"id": "776", "name": "20Гб в Европе 38 стран + Турция + Беларусь на 30 дней", "text": "", "price": "1395", "gigs": "20", "days": "30", "spec": ""},
        {"id": "777", "name": "50Гб в Европе 38 стран + Турция + Беларусь на 30 дней", "text": "", "price": "2595", "gigs": "50", "days": "30", "spec": ""}
    ]},
    {"country": "Африка 18 стран", "text": "Страны\r\nАлжир, Чад, Конго демократическая республика, Республика Конго, Египет, Габон, Гана, Кения, Мадагаскар, Малави, Маврикий, Марокко, Нигер, Нигерия, Реюньон, Tанзания, Тунис, Уганда\r\nОператоры\r\nAlgeria：Orascom, Chad：Zain/Airtel/Celtel, Congo Dem. Rep：ZAIN, Congo Republic：Airtel, Egypt：EMS Mobinil/Etisalat, Gabon：ZAIN/Celtel, Ghana：Vodafone, Kenya：Zain/Celtel, Madagascar：Airtel, Malawi：Airtel, Mauritius：Cellplus Mobile, Morocco：Orange, Niger：Zain/CelTel, Nigeria：Glo/Airtel/ZAIN, Reunion：TELCO, Tanzania：ZAIN/Celtel, Tunisia：Tunisie Telecom/Ooredoo, Uganda：Airtel/Warid", "esims": [
        {"id": "817", "name": "1Гб в Африке 18 стран на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "480", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "818", "name": "1Гб в Африке 18 стран на 5 дней", "text": "", "price": "595", "gigs": "1", "days": "5", "spec": ""},
        {"id": "819", "name": "3Гб в Африке 18 стран на 7 дней", "text": "", "price": "1095", "gigs": "3", "days": "7", "spec": ""},
        {"id": "820", "name": "5Гб в Африке 18 стран на 15 дней", "text": "", "price": "1670", "gigs": "5", "days": "15", "spec": ""},
        {"id": "822", "name": "10Гб в Африке 18 стран на 7 дней", "text": "", "price": "2395", "gigs": "10", "days": "7", "spec": "hot"},
        {"id": "821", "name": "10Гб в Африке 18 стран на 30 дней", "text": "", "price": "2625", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Южная Америка 6 стран", "text": "Страны&amp;nbsp;\r\nБразилия, Аргентина, Чили, Колумбия, Французская Гвиана, Перу\r\nОператоры\r\nBrazil:Vivo/TIM / Claro, Argentina:Claro / Telefonica, Chile:Entel / Claro / Telefonica, Colombia：Telefonica / Claro / Tigo, French Guiana:Orange/Digicel, Peru:Claro (TIM) / Telefonica", "esims": [
        {"id": "833", "name": "1Гб в Южной Америке 6 стран на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "325", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "834", "name": "1Гб в Южной Америке 6 стран на 3 дня", "text": "", "price": "365", "gigs": "1", "days": "3", "spec": ""},
        {"id": "835", "name": "3Гб в Южной Америке 6 стран на 7 дней", "text": "", "price": "760", "gigs": "3", "days": "7", "spec": ""},
        {"id": "836", "name": "5Гб в Южной Америке 6 стран на 15 дней", "text": "", "price": "1195", "gigs": "5", "days": "15", "spec": ""},
        {"id": "838", "name": "7Гб в Южной Америке 6 стран на 7 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "1225", "gigs": "7", "days": "7", "spec": "hot"},
        {"id": "839", "name": "10Гб в Южной Америке 6 стран на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "1695", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "837", "name": "10Гб в Южной Америке 6 стран на 30 дней", "text": "", "price": "1905", "gigs": "10", "days": "30", "spec": ""}
    ]},
])

ESIM_DATA.extend([
    {"country": "Австралия", "text": "Оператор&amp;nbsp;Singtel Optus", "esims": [
        {"id": "390", "name": "1Гб в Австралии на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "225", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "391", "name": "1Гб в Австралии на 3 дня", "text": "", "price": "245", "gigs": "1", "days": "3", "spec": ""},
        {"id": "392", "name": "3Гб в Австралии на 7 дней", "text": "", "price": "395", "gigs": "3", "days": "7", "spec": ""},
        {"id": "393", "name": "5Гб в Австралии на 15 дней", "text": "", "price": "525", "gigs": "5", "days": "15", "spec": ""},
        {"id": "738", "name": "10Гб в Австралии на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости&amp;nbsp;384kbps", "price": "725", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "394", "name": "10Гб в Австралии на 30 дней", "text": "", "price": "845", "gigs": "10", "days": "30", "spec": ""},
        {"id": "826", "name": "20Гб в Австралии на 30 дней", "text": "", "price": "1425", "gigs": "20", "days": "30", "spec": ""},
        {"id": "827", "name": "50Гб в Австралии на 30 дней", "text": "", "price": "3140", "gigs": "50", "days": "30", "spec": ""}
    ]},
    {"country": "Аргентина", "text": "", "esims": [
        {"id": "833", "name": "1Гб в Южной Америке 6 стран на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "325", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "834", "name": "1Гб в Южной Америке 6 стран на 3 дня", "text": "", "price": "365", "gigs": "1", "days": "3", "spec": ""},
        {"id": "835", "name": "3Гб в Южной Америке 6 стран на 7 дней", "text": "", "price": "760", "gigs": "3", "days": "7", "spec": ""},
        {"id": "836", "name": "5Гб в Южной Америке 6 стран на 15 дней", "text": "", "price": "1195", "gigs": "5", "days": "15", "spec": ""},
        {"id": "838", "name": "7Гб в Южной Америке 6 стран на 7 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "1225", "gigs": "7", "days": "7", "spec": "hot"},
        {"id": "839", "name": "10Гб в Южной Америке 6 стран на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "1695", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "837", "name": "10Гб в Южной Америке 6 стран на 30 дней", "text": "", "price": "1905", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Канада", "text": "Операторы в Канаде: Rogers/FIDO (Rogers AT&amp;amp;T/ Microcell)/Bell/SaskTel/Telus/Videotron General Partnership\r\nТакже связь работает и в США, операторы&amp;nbsp;Verizon/AT&amp;amp;T/T-Mobile", "esims": [
        {"id": "446", "name": "1Гб в Канаде на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "250", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "447", "name": "1Гб в Канаде на 3 дня", "text": "", "price": "325", "gigs": "1", "days": "3", "spec": ""},
        {"id": "448", "name": "3Гб в Канаде на 7 дней", "text": "", "price": "545", "gigs": "3", "days": "7", "spec": ""},
        {"id": "831", "name": "7Гб в Канаде на 7 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "865", "gigs": "7", "days": "7", "spec": "hot"},
        {"id": "449", "name": "5Гб в Канаде на 15 дней", "text": "", "price": "885", "gigs": "5", "days": "15", "spec": ""},
        {"id": "832", "name": "10Гб в Канаде на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "1175", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "450", "name": "10Гб в Канаде на 30 дней", "text": "", "price": "1495", "gigs": "10", "days": "30", "spec": ""},
        {"id": "830", "name": "20Гб в Канаде на 30 дней", "text": "", "price": "2665", "gigs": "20", "days": "30", "spec": ""}
    ]},
    {"country": "Индия", "text": "", "esims": [
        {"id": "547", "name": "1Гб в Индии на 1 день", "text": "", "price": "395", "gigs": "1", "days": "1", "spec": ""},
        {"id": "548", "name": "1Гб в Индии на 3 дня", "text": "", "price": "415", "gigs": "1", "days": "3", "spec": ""},
        {"id": "549", "name": "3Гб в Индии на 7 дней", "text": "", "price": "645", "gigs": "3", "days": "7", "spec": ""},
        {"id": "550", "name": "5Гб в Индии на 15 дней", "text": "", "price": "870", "gigs": "5", "days": "15", "spec": ""},
        {"id": "551", "name": "10Гб в Индии на 30 дней", "text": "", "price": "1425", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Индонезия", "text": "Операторы - Telkomsel/XL", "esims": [
        {"id": "552", "name": "1Гб в Индонезии на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "245", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "553", "name": "3Гб в Индонезии на 3 дня", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 384kbps", "price": "320", "gigs": "3", "days": "3", "spec": "hot"},
        {"id": "554", "name": "3Гб в Индонезии на 7 дней", "text": "", "price": "375", "gigs": "3", "days": "7", "spec": ""},
        {"id": "555", "name": "5Гб в Индонезии на 15 дней", "text": "", "price": "520", "gigs": "5", "days": "15", "spec": ""},
        {"id": "556", "name": "10Гб в Индонезии на 15 дней", "text": "", "price": "790", "gigs": "10", "days": "15", "spec": ""},
        {"id": "806", "name": "20Гб в Индонезии на 30 дней", "text": "", "price": "1345", "gigs": "20", "days": "30", "spec": ""},
        {"id": "807", "name": "30Гб в Индонезии на 30 дней", "text": "", "price": "1795", "gigs": "30", "days": "30", "spec": ""}
    ]},
    {"country": "Япония", "text": "", "esims": [
        {"id": "717", "name": "1Гб в Японии на 3 дня", "text": "", "price": "240", "gigs": "1", "days": "3", "spec": "hot"},
        {"id": "718", "name": "3Гб в Японии на 7 дней", "text": "", "price": "375", "gigs": "3", "days": "7", "spec": "hot"},
        {"id": "719", "name": "5Гб в Японии на 15 дней", "text": "", "price": "475", "gigs": "5", "days": "15", "spec": "hot"},
        {"id": "720", "name": "10Гб в Японии на 30 дней", "text": "", "price": "795", "gigs": "10", "days": "30", "spec": "hot"},
        {"id": "721", "name": "20Гб в Японии на 30 дней", "text": "", "price": "1295", "gigs": "20", "days": "30", "spec": "hot"},
        {"id": "722", "name": "50Гб в Японии на 30 дней", "text": "", "price": "2695", "gigs": "50", "days": "30", "spec": "hot"}
    ]},
    {"country": "Южная Корея", "text": "", "esims": [
        {"id": "712", "name": "1Гб в Южной Корее на 3 дня", "text": "", "price": "205", "gigs": "1", "days": "3", "spec": ""},
        {"id": "713", "name": "3Гб в Южной Корее на 7 дней", "text": "", "price": "280", "gigs": "3", "days": "7", "spec": ""},
        {"id": "714", "name": "5Гб в Южной Корее на 15 дней", "text": "", "price": "405", "gigs": "5", "days": "15", "spec": ""},
        {"id": "715", "name": "10Гб в Южной Корее на 30 дней", "text": "", "price": "595", "gigs": "10", "days": "30", "spec": ""},
        {"id": "716", "name": "50Гб в Южной Корее на 30 дней", "text": "", "price": "1895", "gigs": "50", "days": "30", "spec": ""}
    ]},
    {"country": "Сингапур", "text": "", "esims": [
        {"id": "708", "name": "3Гб в Сингапуре на 7 дней", "text": "", "price": "395", "gigs": "3", "days": "7", "spec": ""},
        {"id": "709", "name": "5Гб в Сингапуре на 15 дней", "text": "", "price": "480", "gigs": "5", "days": "15", "spec": ""},
        {"id": "710", "name": "7Гб в Сингапуре на 15 дней", "text": "", "price": "615", "gigs": "7", "days": "15", "spec": ""},
        {"id": "711", "name": "10Гб в Сингапуре на 20 дней", "text": "", "price": "820", "gigs": "10", "days": "20", "spec": ""}
    ]},
    {"country": "Южная Африка", "text": "", "esims": [
        {"id": "734", "name": "1Гб в Южной Африке на 3 дня", "text": "", "price": "365", "gigs": "1", "days": "3", "spec": ""},
        {"id": "735", "name": "3Гб в Южной Африке на 7 дней", "text": "", "price": "625", "gigs": "3", "days": "7", "spec": ""},
        {"id": "736", "name": "5Гб в Южной Африке на 15 дней", "text": "", "price": "995", "gigs": "5", "days": "15", "spec": ""},
        {"id": "733", "name": "10Гб в Южная Африка на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости&amp;nbsp;512kbps", "price": "1325", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "737", "name": "10Гб в Южной Африке на 30 дней", "text": "", "price": "1595", "gigs": "10", "days": "30", "spec": ""}
    ]},
    {"country": "Израиль", "text": "Операторы:\r\nPelephone Israel\r\nHot Mobile Israel\r\nPartner Israel", "esims": [
        {"id": "567", "name": "1Гб в Израиле на 1 день", "text": "", "price": "345", "gigs": "1", "days": "1", "spec": ""},
        {"id": "568", "name": "1Гб в Израиле на 3 дня", "text": "", "price": "360", "gigs": "1", "days": "3", "spec": ""},
        {"id": "569", "name": "3Гб в Израиле на 7 дней", "text": "", "price": "515", "gigs": "3", "days": "7", "spec": ""},
        {"id": "570", "name": "5Гб в Израиле на 15 дней", "text": "", "price": "670", "gigs": "5", "days": "15", "spec": ""},
        {"id": "571", "name": "10Гб в Израиле на 30 дней", "text": "", "price": "1065", "gigs": "10", "days": "30", "spec": ""}
    ]},
])

ESIM_DATA.extend([
    {"country": "Франция", "text": "", "esims": [
        {"id": "739", "name": "1Гб в Европе (32 страны) на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "225", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "740", "name": "3Гб в Европе (32 страны) на 3 дня", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "325", "gigs": "3", "days": "3", "spec": "hot"},
        {"id": "741", "name": "5Гб в Европе (32 страны) на 5 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "395", "gigs": "5", "days": "5", "spec": "hot"},
        {"id": "742", "name": "10Гб в Европе (32 страны) на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "625", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "743", "name": "10Гб в Европе (32 страны) на 30 дней", "text": "", "price": "695", "gigs": "10", "days": "30", "spec": ""},
        {"id": "744", "name": "20Гб в Европе (32 страны) на 30 дней", "text": "", "price": "1095", "gigs": "20", "days": "30", "spec": ""},
        {"id": "745", "name": "30Гб в Европе (32 страны) на 30 дней", "text": "", "price": "1495", "gigs": "30", "days": "30", "spec": ""},
        {"id": "746", "name": "50Гб в Европе (32 страны) на 30 дней", "text": "", "price": "2095", "gigs": "50", "days": "30", "spec": ""}
    ]},
    {"country": "Германия", "text": "", "esims": [
        {"id": "739", "name": "1Гб в Европе (32 страны) на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "225", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "740", "name": "3Гб в Европе (32 страны) на 3 дня", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "325", "gigs": "3", "days": "3", "spec": "hot"},
        {"id": "741", "name": "5Гб в Европе (32 страны) на 5 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "395", "gigs": "5", "days": "5", "spec": "hot"},
        {"id": "742", "name": "10Гб в Европе (32 страны) на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "625", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "743", "name": "10Гб в Европе (32 страны) на 30 дней", "text": "", "price": "695", "gigs": "10", "days": "30", "spec": ""},
        {"id": "744", "name": "20Гб в Европе (32 страны) на 30 дней", "text": "", "price": "1095", "gigs": "20", "days": "30", "spec": ""},
        {"id": "745", "name": "30Гб в Европе (32 страны) на 30 дней", "text": "", "price": "1495", "gigs": "30", "days": "30", "spec": ""},
        {"id": "746", "name": "50Гб в Европе (32 страны) на 30 дней", "text": "", "price": "2095", "gigs": "50", "days": "30", "spec": ""}
    ]},
    {"country": "Испания", "text": "", "esims": [
        {"id": "739", "name": "1Гб в Европе (32 страны) на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "225", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "740", "name": "3Гб в Европе (32 страны) на 3 дня", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "325", "gigs": "3", "days": "3", "spec": "hot"},
        {"id": "741", "name": "5Гб в Европе (32 страны) на 5 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "395", "gigs": "5", "days": "5", "spec": "hot"},
        {"id": "742", "name": "10Гб в Европе (32 страны) на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "625", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "743", "name": "10Гб в Европе (32 страны) на 30 дней", "text": "", "price": "695", "gigs": "10", "days": "30", "spec": ""},
        {"id": "744", "name": "20Гб в Европе (32 страны) на 30 дней", "text": "", "price": "1095", "gigs": "20", "days": "30", "spec": ""},
        {"id": "745", "name": "30Гб в Европе (32 страны) на 30 дней", "text": "", "price": "1495", "gigs": "30", "days": "30", "spec": ""},
        {"id": "746", "name": "50Гб в Европе (32 страны) на 30 дней", "text": "", "price": "2095", "gigs": "50", "days": "30", "spec": ""}
    ]},
    {"country": "Италия", "text": "", "esims": [
        {"id": "739", "name": "1Гб в Европе (32 страны) на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "225", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "740", "name": "3Гб в Европе (32 страны) на 3 дня", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "325", "gigs": "3", "days": "3", "spec": "hot"},
        {"id": "741", "name": "5Гб в Европе (32 страны) на 5 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "395", "gigs": "5", "days": "5", "spec": "hot"},
        {"id": "742", "name": "10Гб в Европе (32 страны) на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "625", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "743", "name": "10Гб в Европе (32 страны) на 30 дней", "text": "", "price": "695", "gigs": "10", "days": "30", "spec": ""},
        {"id": "744", "name": "20Гб в Европе (32 страны) на 30 дней", "text": "", "price": "1095", "gigs": "20", "days": "30", "spec": ""},
        {"id": "745", "name": "30Гб в Европе (32 страны) на 30 дней", "text": "", "price": "1495", "gigs": "30", "days": "30", "spec": ""},
        {"id": "746", "name": "50Гб в Европе (32 страны) на 30 дней", "text": "", "price": "2095", "gigs": "50", "days": "30", "spec": ""}
    ]},
    {"country": "Великобритания", "text": "", "esims": [
        {"id": "739", "name": "1Гб в Европе (32 страны) на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "225", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "740", "name": "3Гб в Европе (32 страны) на 3 дня", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "325", "gigs": "3", "days": "3", "spec": "hot"},
        {"id": "741", "name": "5Гб в Европе (32 страны) на 5 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "395", "gigs": "5", "days": "5", "spec": "hot"},
        {"id": "742", "name": "10Гб в Европе (32 страны) на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "625", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "743", "name": "10Гб в Европе (32 страны) на 30 дней", "text": "", "price": "695", "gigs": "10", "days": "30", "spec": ""},
        {"id": "744", "name": "20Гб в Европе (32 страны) на 30 дней", "text": "", "price": "1095", "gigs": "20", "days": "30", "spec": ""},
        {"id": "745", "name": "30Гб в Европе (32 страны) на 30 дней", "text": "", "price": "1495", "gigs": "30", "days": "30", "spec": ""},
        {"id": "746", "name": "50Гб в Европе (32 страны) на 30 дней", "text": "", "price": "2095", "gigs": "50", "days": "30", "spec": ""}
    ]},
    {"country": "Швейцария", "text": "", "esims": [
        {"id": "739", "name": "1Гб в Европе (32 страны) на 1 день", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "225", "gigs": "1", "days": "1", "spec": "hot"},
        {"id": "740", "name": "3Гб в Европе (32 страны) на 3 дня", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "325", "gigs": "3", "days": "3", "spec": "hot"},
        {"id": "741", "name": "5Гб в Европе (32 страны) на 5 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "395", "gigs": "5", "days": "5", "spec": "hot"},
        {"id": "742", "name": "10Гб в Европе (32 страны) на 10 дней", "text": "Безлимит - 1Гб в день на полной скорости, остальное на скорости 512kbps", "price": "625", "gigs": "10", "days": "10", "spec": "hot"},
        {"id": "743", "name": "10Гб в Европе (32 страны) на 30 дней", "text": "", "price": "695", "gigs": "10", "days": "30", "spec": ""},
        {"id": "744", "name": "20Гб в Европе (32 страны) на 30 дней", "text": "", "price": "1095", "gigs": "20", "days": "30", "spec": ""},
        {"id": "745", "name": "30Гб в Европе (32 страны) на 30 дней", "text": "", "price": "1495", "gigs": "30", "days": "30", "spec": ""},
        {"id": "746", "name": "50Гб в Европе (32 страны) на 30 дней", "text": "", "price": "2095", "gigs": "50", "days": "30", "spec": ""}
    ]},
])

def clean_text(text):
    """Очистка текста от HTML entities"""
    if not text:
        return ""
    # Заменяем HTML entities
    replacements = {
        '&amp;': '&',
        '&nbsp;': ' ',
        '&lt;': '<',
        '&gt;': '>',
        '&quot;': '"',
        '&#39;': "'",
        '\r\n': ' ',
        '\n': ' ',
    }
    for old, new in replacements.items():
        text = text.replace(old, new)
    # Убираем лишние пробелы
    text = ' '.join(text.split())
    return text


def escape_sql_like(value):
    """Экранирование специальных символов для SQL LIKE"""
    if not value:
        return value

    # Экранируем специальные символы SQL LIKE
    escape_chars = ['%', '_', '[', ']', '^', '-', '#']
    result = value
    for char in escape_chars:
        result = result.replace(char, f'\\{char}')

    return result


def init_db():
    """Инициализация базы данных с встроенными данными"""
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()

    # Таблица пользователей
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        username TEXT,
        first_name TEXT,
        last_name TEXT,
        registered_at TEXT
    )
    ''')

    # Таблица стран
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS countries (
        country_id INTEGER PRIMARY KEY AUTOINCREMENT,
        country_name TEXT UNIQUE,
        operators TEXT,
        description TEXT
    )
    ''')

    # Таблица eSIM карт
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS esims (
        id INTEGER PRIMARY KEY,
        country_id INTEGER,
        name TEXT,
        description TEXT,
        price REAL,
        gigs TEXT,
        days TEXT,
        spec TEXT,
        FOREIGN KEY (country_id) REFERENCES countries (country_id)
    )
    ''')

    # Проверяем, есть ли уже данные
    cursor.execute("SELECT COUNT(*) FROM countries")
    if cursor.fetchone()[0] == 0:
        logger.info("Загружаем данные из встроенного JSON...")

        # Добавляем страны и eSIM карты из встроенных данных
        country_count = 0
        esim_count = 0

        for country_data in ESIM_DATA:
            try:
                country_name = country_data['country']

                # Очищаем текст операторов
                operators = clean_text(country_data.get('text', ''))

                # Добавляем страну
                cursor.execute(
                    "INSERT OR IGNORE INTO countries (country_name, operators, description) VALUES (?, ?, ?)",
                    (country_name, operators, '')
                )

                # Получаем ID страны
                cursor.execute("SELECT country_id FROM countries WHERE country_name = ?", (country_name,))
                country_result = cursor.fetchone()

                if country_result:
                    country_id = country_result[0]
                    country_count += 1

                    # Добавляем eSIM карты для этой страны
                    for esim in country_data.get('esims', []):
                        try:
                            # Очищаем описание
                            description = clean_text(esim.get('text', ''))

                            cursor.execute(
                                """INSERT OR REPLACE INTO esims 
                                (id, country_id, name, description, price, gigs, days, spec) 
                                VALUES (?, ?, ?, ?, ?, ?, ?, ?)""",
                                (
                                    int(esim['id']),
                                    country_id,
                                    esim['name'],
                                    description,
                                    float(esim['price']),
                                    esim['gigs'],
                                    esim['days'],
                                    esim.get('spec', '')
                                )
                            )
                            esim_count += 1
                        except Exception as e:
                            logger.error(f"Ошибка при добавлении eSIM {esim.get('id', 'unknown')}: {e}")
                            continue
            except Exception as e:
                logger.error(f"Ошибка при обработке страны: {e}")
                continue

        logger.info(f"Добавлено {country_count} стран и {esim_count} eSIM карт")

        # Если данных мало, добавляем демо-данные
        if country_count < 5:
            logger.info("Добавляем дополнительные демо-данные...")

            demo_countries = [
                ("Тайланд", "", ""),
                ("Китай", "", ""),
                ("Германия", "", ""),
                ("Франция", "", ""),
                ("Испания", "", ""),
                ("Италия", "", ""),
                ("Япония", "", ""),
                ("Вьетнам", "", ""),
                ("Индия", "", ""),
                ("Египет", "", ""),
                ("Греция", "", ""),
            ]

            for country_name, operators, description in demo_countries:
                cursor.execute(
                    "INSERT OR IGNORE INTO countries (country_name, operators, description) VALUES (?, ?, ?)",
                    (country_name, operators, description)
                )

            logger.info("Добавлены дополнительные демо-данные")

    conn.commit()
    conn.close()
    logger.info("База данных инициализирована")


init_db()


# Состояния для FSM
class UserState(StatesGroup):
    waiting_for_country_search = State()


# Главное меню
def get_main_menu():
    keyboard = InlineKeyboardBuilder()
    keyboard.row(
        InlineKeyboardButton(text="🌍 Поиск eSIM", callback_data="search_esim"),
        InlineKeyboardButton(text="❓ Помощь", callback_data="help")
    )
    # Кнопка для открытия сайта
    keyboard.row(
        InlineKeyboardButton(text="📱 Открыть сайт", url="https://esimzone.ru/")
    )
    return keyboard.as_markup()


# Клавиатура для страны с eSIM картами
def get_country_esims_keyboard(country_id, page=0, items_per_page=8):
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()

    # Получаем общее количество eSIM для страны
    cursor.execute("SELECT COUNT(*) FROM esims WHERE country_id = ?", (country_id,))
    total_count = cursor.fetchone()[0]

    # Получаем eSIM для текущей страницы
    cursor.execute(
        """SELECT id, name, price, gigs, days, spec 
        FROM esims 
        WHERE country_id = ? 
        ORDER BY 
            CASE WHEN spec = 'hot' THEN 0 ELSE 1 END,
            CAST(price AS REAL)
        LIMIT ? OFFSET ?""",
        (country_id, items_per_page, page * items_per_page)
    )
    esims = cursor.fetchall()

    # Получаем название страны
    cursor.execute("SELECT country_name FROM countries WHERE country_id = ?", (country_id,))
    country_name = cursor.fetchone()[0]
    conn.close()

    keyboard = InlineKeyboardBuilder()

    # Добавляем кнопки для каждого eSIM
    for esim in esims:
        esim_id, name, price, gigs, days, spec = esim
        hot_icon = "🔥 " if spec == 'hot' else ""

        # Создаем короткое название для кнопки
        button_text = f"{hot_icon}{gigs}ГБ/{days}д - {price}₽"
        if len(button_text) > 64:
            button_text = button_text[:61] + "..."

        keyboard.row(
            InlineKeyboardButton(
                text=button_text,
                callback_data=f"esim_{esim_id}"
            )
        )

    # Кнопки навигации по страницам
    nav_buttons = []
    if page > 0:
        nav_buttons.append(InlineKeyboardButton(
            text="⬅️ Назад",
            callback_data=f"country_page_{country_id}_{page - 1}"
        ))

    if (page + 1) * items_per_page < total_count:
        nav_buttons.append(InlineKeyboardButton(
            text="Вперед ➡️",
            callback_data=f"country_page_{country_id}_{page + 1}"
        ))

    if nav_buttons:
        keyboard.row(*nav_buttons)

    # Кнопки навигации
    keyboard.row(
        InlineKeyboardButton(text="🔍 Искать другую страну", callback_data="search_esim"),
        InlineKeyboardButton(text="📱 Открыть сайт", url="https://esimzone.ru/")
    )
    keyboard.row(
        InlineKeyboardButton(text="↩️ В главное меню", callback_data="main_menu")
    )

    # Текст сообщения
    page_info = f" (страница {page + 1})" if total_count > items_per_page else ""
    text = f"🌍 **{country_name}**{page_info}\n\n📱 **Доступные тарифы:**\n"

    # Добавляем краткую информацию о каждом тарифе
    for i, esim in enumerate(esims, 1):
        esim_id, name, price, gigs, days, spec = esim
        hot_icon = "🔥 " if spec == 'hot' else ""
        text += f"\n{i}. {hot_icon}**{name}**\n   📊 {gigs}ГБ | ⏱️ {days} дней | 💰 {price}₽"

    if total_count > items_per_page:
        text += f"\n\n📄 Показано {len(esims)} из {total_count} тарифов"

    return text, keyboard.as_markup()


# Клавиатура для eSIM карты с WebApp для оплаты
def get_esim_keyboard(esim_id, esim_name, country_name):
    keyboard = InlineKeyboardBuilder()

    # Генерируем ссылку для оплаты с ID eSIM
    payment_url = f"{BASE_PAYMENT_URL}{esim_id}"

    # Кнопка покупки через WebApp (виджет в Telegram)
    keyboard.row(
        InlineKeyboardButton(
            text="💳 Купить через Telegram",
            web_app=WebAppInfo(url=payment_url)
        )
    )

    # Альтернативная кнопка для браузера
    keyboard.row(
        InlineKeyboardButton(
            text="🌐 Купить в браузере",
            url=payment_url
        )
    )

    keyboard.row(
        InlineKeyboardButton(text="◀️ К списку тарифов", callback_data=f"back_to_country_{esim_id}"),
        InlineKeyboardButton(text="🔍 Другие страны", callback_data="search_esim")
    )
    keyboard.row(
        InlineKeyboardButton(text="↩️ В главное меню", callback_data="main_menu")
    )

    return keyboard


# Обработчик команды /start
@dp.message(Command("start"))
async def send_welcome(message: types.Message):
    user_id = message.from_user.id

    # Сохраняем пользователя в БД
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()

    # Преобразуем datetime в строку для совместимости
    registered_at = datetime.now().isoformat()

    cursor.execute(
        "INSERT OR IGNORE INTO users (user_id, username, first_name, last_name, registered_at) VALUES (?, ?, ?, ?, ?)",
        (user_id, message.from_user.username, message.from_user.first_name,
         message.from_user.last_name, registered_at)
    )
    conn.commit()
    conn.close()

    welcome_text = (
        "👋 **Добро пожаловать в eSIMZone Bot!**\n\n"
        "🌍 Здесь вы можете найти eSIM для путешествий в **180+ стран**.\n"
        "📱 Просто введите название страны для поиска доступных тарифов.\n\n"
        "**Примеры:**\n"
        "• `Турция`\n"
        "• `США`\n"
        "• `Казахстан`\n"
        "• `Тайланд`\n"
        "• `Германия`\n\n"
        "Или используйте кнопки ниже:"
    )

    await message.answer(welcome_text, reply_markup=get_main_menu(), parse_mode="Markdown")


# Обработчик кнопки поиска eSIM
@dp.callback_query(F.data == "search_esim")
async def process_search_esim(callback_query: types.CallbackQuery, state: FSMContext):
    await callback_query.answer()
    await state.set_state(UserState.waiting_for_country_search)

    await callback_query.message.edit_text(
        "🔍 **Поиск eSIM по стране**\n\n"
        "Введите название страны для поиска доступных тарифов.\n\n"
        "**Примеры запросов:**\n"
        "• `Турция` - все тарифы для Турции\n"
        "• `США` - все тарифы для США\n"
        "• `Казахстан` - все тарифы для Казахстана\n"
        "• `Европа` - групповые тарифы для Европы\n"
        "• `Азия` - страны Азии\n\n"
        "Просто напишите название интересующей вас страны:",
        parse_mode="Markdown"
    )


# Обработчик текстовых сообщений для поиска страны
@dp.message(UserState.waiting_for_country_search)
async def process_country_search(message: types.Message, state: FSMContext):
    search_query = message.text.strip()

    if not search_query:
        await message.answer("Пожалуйста, введите название страны для поиска.")
        return

    # Если пользователь ввел команду, обрабатываем её
    if search_query.startswith('/'):
        return

    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()

    # Экранируем специальные символы в запросе
    safe_search_query = escape_sql_like(search_query)

    try:
        # Ищем страну по точному или частичному совпадению
        cursor.execute(
            """SELECT country_id, country_name 
            FROM countries 
            WHERE country_name LIKE ? 
            ORDER BY 
                CASE 
                    WHEN country_name = ? THEN 0  -- Точное совпадение
                    WHEN country_name LIKE ? THEN 1  -- Начинается с запроса
                    ELSE 2  -- Частичное совпадение
                END,
                country_name
            LIMIT 1""",
            (f'%{safe_search_query}%', search_query, f'{safe_search_query}%')
        )

        country_result = cursor.fetchone()

    except Exception as e:
        logger.error(f"Ошибка при поиске '{search_query}': {e}")
        await message.answer(
            "⚠️ **Ошибка при поиске.**\n"
            "Попробуйте ввести название страны без специальных символов.",
            parse_mode="Markdown"
        )
        conn.close()
        await state.clear()
        return

    if not country_result:
        # Если не найдено
        text = (
            f"🌍 **Страна '{search_query}' не найдена.**\n\n"
            "Убедитесь, что название введено правильно.\n"
            "**Примеры запросов:**\n"
            "• `Турция`\n• `США`\n• `Казахстан`\n• `Тайланд`"
        )

        keyboard = InlineKeyboardBuilder()
        keyboard.row(
            InlineKeyboardButton(text="🔍 Попробовать снова", callback_data="search_esim"),
            InlineKeyboardButton(text="↩️ В главное меню", callback_data="main_menu")
        )

        await message.answer(text, reply_markup=keyboard.as_markup(), parse_mode="Markdown")

        conn.close()
        await state.clear()
        return

    country_id, country_name = country_result

    # Получаем количество eSIM для страны
    try:
        cursor.execute("SELECT COUNT(*) FROM esims WHERE country_id = ?", (country_id,))
        esim_count = cursor.fetchone()[0]
    except Exception as e:
        logger.error(f"Ошибка при подсчете eSIM для страны {country_id}: {e}")
        await message.answer(
            f"⚠️ **Ошибка при загрузке данных для {country_name}.**\n"
            "Попробуйте позже или выберите другую страну.",
            parse_mode="Markdown"
        )
        conn.close()
        await state.clear()
        return

    conn.close()

    if esim_count == 0:
        text = f"🌍 **{country_name}**\n\n"
        text += "К сожалению, для этой страны пока нет доступных eSIM тарифов.\n\n"
        text += "Вы можете:\n"
        text += "• Посмотреть другие страны\n"
        text += f"• Перейти на сайт для покупки eSIM"

        keyboard = InlineKeyboardBuilder()
        keyboard.row(
            InlineKeyboardButton(
                text="📱 Открыть сайт",
                url="https://esimzone.ru/"
            )
        )
        keyboard.row(
            InlineKeyboardButton(text="🔍 Искать другую страну", callback_data="search_esim"),
            InlineKeyboardButton(text="↩️ В главное меню", callback_data="main_menu")
        )

        await message.answer(text, reply_markup=keyboard.as_markup(), parse_mode="Markdown")
    else:
        # Показываем eSIM карты для страны
        try:
            text, keyboard = get_country_esims_keyboard(country_id)
            await message.answer(text, reply_markup=keyboard, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"Ошибка при показе eSIM для страны {country_id}: {e}")
            await message.answer(
                f"⚠️ **Ошибка при загрузке тарифов для {country_name}.**\n"
                "Попробуйте позже или выберите другую страну.",
                parse_mode="Markdown"
            )

    await state.clear()


# Показать eSIM для страны (для callback)
@dp.callback_query(F.data.startswith("country_page_"))
async def show_country_esims(callback_query: types.CallbackQuery):
    await callback_query.answer()

    # Формат: country_page_{id}_{page}
    parts = callback_query.data.split('_')
    if len(parts) >= 4:
        country_id = parts[2]
        page = int(parts[3])
    else:
        return

    try:
        text, keyboard = get_country_esims_keyboard(country_id, page)
        await callback_query.message.edit_text(text, reply_markup=keyboard, parse_mode="Markdown")
    except Exception as e:
        logger.error(f"Ошибка при показе страницы {page} для страны {country_id}: {e}")
        await callback_query.message.edit_text(
            "⚠️ **Ошибка при загрузке данных.**\n"
            "Попробуйте позже.",
            parse_mode="Markdown"
        )


# Показать информацию о eSIM
@dp.callback_query(F.data.startswith("esim_"))
async def show_esim_info(callback_query: types.CallbackQuery):
    await callback_query.answer()
    esim_id = callback_query.data.split('_')[1]

    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()

    try:
        # Получаем подробную информацию о eSIM
        cursor.execute(
            """SELECT e.name, e.description, e.price, e.gigs, e.days, e.spec, 
                      c.country_name, c.country_id 
               FROM esims e
               JOIN countries c ON e.country_id = c.country_id
               WHERE e.id = ?""",
            (esim_id,)
        )
        esim_data = cursor.fetchone()
    except Exception as e:
        logger.error(f"Ошибка при получении eSIM {esim_id}: {e}")
        await callback_query.message.edit_text("⚠️ **Ошибка при загрузке данных eSIM.**")
        conn.close()
        return

    conn.close()

    if not esim_data:
        await callback_query.message.edit_text("eSIM не найден.")
        return

    name, description, price, gigs, days, spec, country_name, country_id = esim_data

    hot_badge = " 🔥 **ГОРЯЧЕЕ ПРЕДЛОЖЕНИЕ**" if spec == 'hot' else ""

    text = (
        f"🌍 **Страна:** {country_name}\n"
        f"📱 **Тариф:** {name}{hot_badge}\n\n"
        f"📊 **Объем данных:** {gigs}ГБ\n"
        f"⏱️ **Срок действия:** {days} дней\n"
        f"💰 **Цена:** {price}₽\n\n"
    )

    if description:
        text += f"📝 **Описание:**\n{description}\n\n"

    text += "Для покупки этого тарифа нажмите кнопку ниже:"

    try:
        keyboard = get_esim_keyboard(esim_id, name, country_name)
        await callback_query.message.edit_text(
            text,
            reply_markup=keyboard.as_markup(),
            parse_mode="Markdown"
        )
    except Exception as e:
        logger.error(f"Ошибка при показе eSIM {esim_id}: {e}")
        # Альтернатива: простая ссылка
        payment_url = f"{BASE_PAYMENT_URL}{esim_id}"
        await callback_query.message.edit_text(
            f"🌍 **Страна:** {country_name}\n"
            f"📱 **Тариф:** {name}{hot_badge}\n\n"
            f"📊 **Объем данных:** {gigs}ГБ\n"
            f"⏱️ **Срок действия:** {days} дней\n"
            f"💰 **Цена:** {price}₽\n\n"
            f"Для покупки перейдите по ссылке:\n{payment_url}",
            parse_mode="Markdown"
        )


# Кнопка "Назад к списку тарифов"
@dp.callback_query(F.data.startswith("back_to_country_"))
async def back_to_country(callback_query: types.CallbackQuery):
    await callback_query.answer()
    parts = callback_query.data.split('_')
    if len(parts) >= 4:
        esim_id = parts[3]

        # Находим страну для этого eSIM
        conn = sqlite3.connect(DB_NAME)
        cursor = conn.cursor()
        try:
            cursor.execute(
                "SELECT country_id FROM esims WHERE id = ?",
                (esim_id,)
            )
            result = cursor.fetchone()
        except Exception as e:
            logger.error(f"Ошибка при поиске страны для eSIM {esim_id}: {e}")
            await callback_query.message.edit_text("⚠️ **Ошибка при загрузке данных.**")
            conn.close()
            return

        conn.close()

        if result:
            country_id = result[0]
            try:
                text, keyboard = get_country_esims_keyboard(country_id)
                await callback_query.message.edit_text(text, reply_markup=keyboard, parse_mode="Markdown")
            except Exception as e:
                logger.error(f"Ошибка при возврате к стране {country_id}: {e}")
                await callback_query.message.edit_text(
                    "⚠️ **Ошибка при загрузке данных.**\n"
                    "Попробуйте позже.",
                    parse_mode="Markdown"
                )


# Помощь
@dp.callback_query(F.data == "help")
async def process_help(callback_query: types.CallbackQuery):
    await callback_query.answer()

    help_text = (
        "❓ **Помощь и поддержка**\n\n"
        "🤔 **Как найти eSIM?**\n"
        "1. Нажмите 'Поиск eSIM'\n"
        "2. Введите название страны (например: `Турция`)\n"
        "3. Выберите подходящий тариф\n"
        "4. Нажмите 'Купить через Telegram' для оплаты\n\n"

        "🌍 **Доступные страны:**\n"
        "• **180+ стран** по всему миру\n"
        "• Страны Европы, Азии, Америки, Африки\n"
        "• Групповые тарифы (Европа, Азия и др.)\n\n"

        "💳 **Как купить?**\n"
        "1. Выберите страну и тариф в боте\n"
        "2. Нажмите 'Купить через Telegram'\n"
        "3. Оплатите прямо в Telegram-виджете\n"
        "4. Получите QR-код для активации\n\n"

        "📱 **Активация eSIM:**\n"
        "1. Откройте настройки телефона\n"
        "2. Выберите 'Сотовая связь' или 'Мобильная сеть'\n"
        "3. Нажмите 'Добавить тарифный план'\n"
        "4. Отсканируйте QR-код\n\n"

        "⚠️ **Важно:**\n"
        "• Убедитесь, что телефон поддерживает eSIM\n"
        "• Телефон должен быть разблокирован\n"
        "• Активируйте eSIM в стране назначения\n\n"

        "🔄 **Возврат средств:**\n"
        "Возврат возможен в течение 24 часов после покупки, если eSIM не был активирован.\n\n"

        "📞 **Поддержка:**\n"
        "• Сайт: https://esimzone.ru/\n"
        "• Телефон: +7 (927) 631-22-61"
    )

    keyboard = InlineKeyboardBuilder()
    keyboard.row(
        InlineKeyboardButton(text="🌍 Начать поиск", callback_data="search_esim"),
        InlineKeyboardButton(text="📱 Открыть сайт", url="https://esimzone.ru/")
    )
    keyboard.row(
        InlineKeyboardButton(text="↩️ В главное меню", callback_data="main_menu")
    )

    await callback_query.message.edit_text(help_text, reply_markup=keyboard.as_markup(), parse_mode="Markdown")


# Обработчик кнопки "Назад" в главное меню
@dp.callback_query(F.data == "main_menu")
async def process_main_menu(callback_query: types.CallbackQuery):
    await callback_query.answer()

    welcome_text = (
        "👋 **Добро пожаловать в eSIMZone Bot!**\n\n"
        "🌍 Здесь вы можете найти eSIM для путешествий в **180+ стран**.\n"
        "📱 Просто введите название страны для поиска доступных тарифов.\n\n"
        "**Примеры:**\n"
        "• `Турция`\n"
        "• `США`\n"
        "• `Казахстан`\n"
        "• `Тайланд`\n"
        "• `Германия`\n\n"
        "Или используйте кнопки ниже:"
    )

    await callback_query.message.edit_text(welcome_text, reply_markup=get_main_menu(), parse_mode="Markdown")


# Команда для быстрого поиска страны
@dp.message(Command("search"))
async def quick_search(message: types.Message, state: FSMContext):
    if len(message.text.split()) > 1:
        search_query = ' '.join(message.text.split()[1:])
        await state.set_state(UserState.waiting_for_country_search)
        await process_country_search(message, state)
    else:
        await message.answer(
            "🔍 **Быстрый поиск страны**\n\n"
            "Используйте команду в формате:\n"
            "`/search Турция` - для поиска Турции\n"
            "`/search США` - для поиска США\n"
            "`/search Казахстан` - для поиска Казахстана\n\n"
            "Или используйте кнопку ниже для обычного поиска:",
            reply_markup=InlineKeyboardBuilder()
            .add(InlineKeyboardButton(text="🔍 Поиск страны", callback_data="search_esim"))
            .as_markup(),
            parse_mode="Markdown"
        )


# Обработчик текстовых сообщений (главное меню)
@dp.message(F.text)
async def process_text_message(message: types.Message, state: FSMContext):
    text = message.text.strip()

    if text.lower() in ["меню", "начать", "старт", "start", "/start"]:
        welcome_text = (
            "👋 **Добро пожаловать в eSIMZone Bot!**\n\n"
            "🌍 Здесь вы можете найти eSIM для путешествий в **180+ стран**.\n"
            "📱 Просто введите название страны для поиска доступных тарифов.\n\n"
            "**Примеры:**\n"
            "• `Турция`\n"
            "• `США`\n"
            "• `Казахстан`\n"
            "• `Тайланд`\n"
            "• `Германия`\n\n"
            "Или используйте кнопки ниже:"
        )
        await message.answer(welcome_text, reply_markup=get_main_menu(), parse_mode="Markdown")
    elif text.lower() in ["помощь", "help", "поддержка"]:
        # Создаем фиктивный callback для обработки помощи
        class FakeCallback:
            def __init__(self, from_user, message):
                self.from_user = from_user
                self.message = message
                self.data = "help"
                self.id = "fake_help"
                self.chat_instance = "test"

            async def answer(self):
                pass

        fake_callback = FakeCallback(message.from_user, message)
        await process_help(fake_callback)
    elif text.lower() in ["каталог", "catalog", "сайт"]:
        keyboard = InlineKeyboardBuilder()
        keyboard.row(
            InlineKeyboardButton(
                text="📱 Открыть сайт esimzone.ru",
                url="https://esimzone.ru/"
            )
        )
        await message.answer(
            "Нажмите кнопку ниже, чтобы открыть полный каталог eSIM на нашем сайте:",
            reply_markup=keyboard.as_markup()
        )
    else:
        # Если не команда, обрабатываем как поиск страны
        await state.set_state(UserState.waiting_for_country_search)
        await process_country_search(message, state)


async def delete_webhook():
    """Удаляем вебхук перед запуском polling"""
    try:
        await bot.delete_webhook(drop_pending_updates=True)
        logger.info("Вебхук успешно удален")
    except Exception as e:
        logger.warning(f"Не удалось удалить вебхук: {e}")


async def main():
    # Удаляем вебхук перед запуском
    await delete_webhook()

    logger.info("Бот запущен...")
    await dp.start_polling(bot)


if __name__ == '__main__':
    try:
        asyncio.run(main())
    except RuntimeError as e:
        if "running event loop" in str(e):
            try:
                import nest_asyncio

                nest_asyncio.apply()
                asyncio.run(main())
            except ImportError:
                loop = asyncio.get_event_loop()
                if loop.is_running():
                    loop.create_task(main())
                else:
                    loop.run_until_complete(main())
        else:
            logger.error(f"Ошибка при запуске: {e}")
            raise e
    except Exception as e:
        logger.error(f"Ошибка при запуске: {e}")
        raise e